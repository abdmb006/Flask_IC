<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROI Selector & OCR</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    canvas { border: 1px solid #000; margin-top: 10px; }
    .roi-item { margin-bottom: 5px; }
    #ocr-output { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
</style>
</head>
<body class="container my-4">

<h2>Upload Image & Select ROIs</h2>
<div class="mb-3">
    <input class="form-control" type="file" id="imageInput" accept="image/*">
</div>

<canvas id="canvas"></canvas>

<h3 class="mt-3">Defined ROIs</h3>
<div id="roi-list" class="mb-3"></div>

<button id="saveROIs" class="btn btn-success">Save ROIs & Original Image</button>
<button id="runOCR" class="btn btn-primary mt-2">Run OCR</button>

<div id="ocr-output"></div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let rois = [];
const labels = ["No Kad Pengenalan", "Nama", "Alamat", "Jantina"];

document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

img.onload = function() {
    canvas.width = img.width > 900 ? 900 : img.width;
    const scale = canvas.width / img.width;
    canvas.height = img.height * scale;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

let drawing = false;
let startX, startY;

canvas.addEventListener('mousedown', (e) => {
    startX = e.offsetX;
    startY = e.offsetY;
    drawing = true;
});

canvas.addEventListener('mousemove', (e) => {
    if (!drawing) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    rois.forEach(r => drawRect(r));
    drawRect({x: startX, y: startY, w: e.offsetX - startX, h: e.offsetY - startY, label: ''});
});

canvas.addEventListener('mouseup', (e) => {
    drawing = false;
    let roi = {x: startX, y: startY, w: e.offsetX - startX, h: e.offsetY - startY};
    let label = prompt("Enter label for this ROI", labels[0]);
    if (!label) label = "ROI_" + (rois.length + 1);
    roi.label = label;
    rois.push(roi);
    drawRect(roi);
    updateROIList();
});

function drawRect(r) {
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(r.x, r.y, r.w, r.h);
    if (r.label) {
        ctx.font = "16px Arial";
        ctx.fillStyle = "red";
        ctx.fillText(r.label, r.x + 5, r.y + 20);
    }
}

function updateROIList() {
    const list = document.getElementById('roi-list');
    list.innerHTML = '';
    rois.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'roi-item';
        div.innerHTML = `
            <span class="badge bg-secondary">${r.label}</span>
            x=${Math.round(r.x)}, y=${Math.round(r.y)}, w=${Math.round(r.w)}, h=${Math.round(r.h)}
            <button class="btn btn-sm btn-danger ms-2" onclick="removeROI(${i})">Remove</button>
        `;
        list.appendChild(div);
    });
}

function removeROI(index) {
    rois.splice(index, 1);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    rois.forEach(r => drawRect(r));
    updateROIList();
}

// Save ROIs & Original Image
document.getElementById('saveROIs').addEventListener('click', () => {
    if (rois.length === 0) { alert("No ROIs to save!"); return; }

    const fileInput = document.getElementById('imageInput');
    if (!fileInput.files[0]) { alert("No image selected!"); return; }

    const formData = new FormData();
    formData.append('image', fileInput.files[0]);  // original image
    formData.append('rois', JSON.stringify(rois));

    fetch('/save_rois', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => alert(data.message))
        .catch(err => alert("Error saving ROIs & image"));
});

// Run OCR
document.getElementById('runOCR').addEventListener('click', () => {
    fetch('/run_ocr', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            const output = document.getElementById('ocr-output');
            if(data.success){
                let html = "<h5>OCR Results:</h5>";
                html += '<table class="table table-bordered"><thead><tr><th>Label</th><th>Text</th></tr></thead><tbody>';
                for(const [label, text] of Object.entries(data.results)){
                    html += `<tr><td>${label}</td><td>${text}</td></tr>`;
                }
                html += '</tbody></table>';
                output.innerHTML = html;
            } else {
                output.innerHTML = `<span class="text-danger">${data.message}</span>`;
            }
        });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
