<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROI Selector & OCR</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    canvas { border: 1px solid #000; margin-top: 10px; }
    .roi-item { margin-bottom: 5px; }
    #ocr-output { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    #video { border: 1px solid #000; margin-top: 10px; }
    #capturedImage { max-width: 100%; margin-top: 10px; }
</style>
</head>
<body class="container my-4">

<h2>Select Image</h2>

<div class="mb-3">
    <label class="form-label"><strong>Upload Image</strong></label>
    <input class="form-control" type="file" id="imageInput" accept="image/*">
</div>

<div class="mb-3">
    <label class="form-label"><strong>Or Capture from Webcam</strong></label><br>
    <button id="openWebcam" class="btn btn-warning">Open Webcam</button>
    <button id="captureBtn" class="btn btn-info ms-2" disabled>Capture</button><br>
    <video id="video" width="640" height="480" autoplay style="display:none;"></video>
    <canvas id="webcamCanvas" style="display:none;"></canvas>
    <img id="capturedImage" src="">
</div>

<canvas id="canvas"></canvas>

<h3 class="mt-3">Defined ROIs</h3>
<div id="roi-list" class="mb-3"></div>

<button id="saveROIs" class="btn btn-success">Save ROIs & Original Image</button>
<button id="runOCR" class="btn btn-primary mt-2">Run OCR</button>

<div id="ocr-output"></div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let rois = [];

// ---------- Upload Image ----------
document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert("Please select a valid image!"); return; }
    const reader = new FileReader();
    reader.onload = function(event) { img.src = event.target.result; };
    reader.readAsDataURL(file);
});

// ---------- Webcam ----------
const video = document.getElementById('video');
const canvasWebcam = document.getElementById('webcamCanvas');
const capturedImg = document.getElementById('capturedImage');
let webcamStream = null;

document.getElementById('openWebcam').addEventListener('click', async () => {
    try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = webcamStream;
        video.style.display = 'block';
        document.getElementById('captureBtn').disabled = false;
    } catch(err) {
        alert("Error accessing webcam: " + err);
    }
});

document.getElementById('captureBtn').addEventListener('click', () => {
    canvasWebcam.width = video.videoWidth;
    canvasWebcam.height = video.videoHeight;
    canvasWebcam.getContext('2d').drawImage(video, 0, 0);
    const dataURL = canvasWebcam.toDataURL('image/png');
    capturedImg.src = dataURL;
    img.src = dataURL;
    video.style.display = 'none';
    webcamStream.getTracks().forEach(track => track.stop());
});

// ---------- Canvas & ROI ----------
img.onload = function() {
    canvas.width = img.width > 900 ? 900 : img.width;
    const scale = canvas.width / img.width;
    canvas.height = img.height * scale;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

let drawing = false, startX, startY;

canvas.addEventListener('mousedown', e => { startX = e.offsetX; startY = e.offsetY; drawing = true; });
canvas.addEventListener('mousemove', e => {
    if (!drawing) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    rois.forEach(r => drawRect(r));
    drawRect({x: startX, y: startY, w: e.offsetX - startX, h: e.offsetY - startY, label: ''});
});
canvas.addEventListener('mouseup', e => {
    drawing = false;
    let roi = {x: startX, y: startY, w: e.offsetX - startX, h: e.offsetY - startY};
    let label = prompt("Enter label for this ROI", "ROI_" + (rois.length+1));
    roi.label = label || "ROI_" + (rois.length+1);
    rois.push(roi);
    drawRect(roi);
    updateROIList();
});

function drawRect(r){
    ctx.strokeStyle='red'; ctx.lineWidth=2;
    ctx.strokeRect(r.x,r.y,r.w,r.h);
    if(r.label){ ctx.font="16px Arial"; ctx.fillStyle="red"; ctx.fillText(r.label,r.x+5,r.y+20);}
}

function updateROIList(){
    const list = document.getElementById('roi-list'); list.innerHTML='';
    rois.forEach((r,i)=>{
        const div = document.createElement('div'); div.className='roi-item';
        div.innerHTML=`<span class="badge bg-secondary">${r.label}</span> x=${Math.round(r.x)},y=${Math.round(r.y)},w=${Math.round(r.w)},h=${Math.round(r.h)} <button class="btn btn-sm btn-danger ms-2" onclick="removeROI(${i})">Remove</button>`;
        list.appendChild(div);
    });
}

function removeROI(index){
    rois.splice(index,1);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    rois.forEach(r=>drawRect(r));
    updateROIList();
}

// ---------- Save ROIs & Image ----------
document.getElementById('saveROIs').addEventListener('click', ()=>{
    if(rois.length===0){ alert("No ROIs to save!"); return;}
    const formData = new FormData();

    if(capturedImg.src){
        fetch(capturedImg.src).then(r=>r.blob()).then(blob=>{
            formData.append('image',blob,'captured.png');
            formData.append('rois',JSON.stringify(rois));
            return fetch('/save_rois',{method:'POST',body:formData});
        }).then(res=>res.json()).then(data=>alert(data.message)).catch(err=>alert("Error saving webcam image & ROIs"));
    } else {
        const fileInput = document.getElementById('imageInput');
        if(!fileInput.files[0]){ alert("Please select a valid image!"); return;}
        const file=fileInput.files[0];
        if(!file.type.startsWith('image/')){ alert("File is not an image!"); return;}
        formData.append('image',file);
        formData.append('rois',JSON.stringify(rois));
        fetch('/save_rois',{method:'POST',body:formData}).then(res=>res.json()).then(data=>alert(data.message)).catch(err=>alert("Error saving uploaded image & ROIs"));
    }
});

// ---------- Run OCR ----------
document.getElementById('runOCR').addEventListener('click',()=>{
    fetch('/run_ocr',{method:'POST'}).then(r=>r.json()).then(data=>{
        const output=document.getElementById('ocr-output');
        if(data.success){
            let html="<h5>OCR Results:</h5><table class='table table-bordered'><thead><tr><th>Label</th><th>Text</th></tr></thead><tbody>";
            for(const [label,text] of Object.entries(data.results)){
                if(label!=="output_image") html+=`<tr><td>${label}</td><td>${text}</td></tr>`;
            }
            html+="</tbody></table>";
            output.innerHTML=html+`<h5>Image with ROIs:</h5><img src="/outputs/KadPengenalan_dengan_ROI.png" style="max-width:100%;">`;
        } else { output.innerHTML=`<span class="text-danger">${data.message}</span>`; }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
